<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆæ’è¡Œæ¦œ - H.AiGame</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="icon" href="/images/game.png" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .leaderboard-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .game-selector {
            margin-bottom: 20px;
        }

        .game-selector select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 16px;
            min-width: 200px;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .leaderboard-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .leaderboard-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .leaderboard-table tr:hover {
            background-color: #f0f0f0;
        }

        .rank-number {
            font-weight: bold;
            width: 60px;
        }

        .top-3 {
            position: relative;
        }

        .rank-1 {
            color: #FFD700;
            /* é‡‘è‰² */
        }

        .rank-2 {
            color: #C0C0C0;
            /* é“¶è‰² */
        }

        .rank-3 {
            color: #CD7F32;
            /* é“œè‰² */
        }

        .medal {
            margin-right: 5px;
        }

        .user-score {
            background-color: #e6f7ff;
            font-weight: bold;
        }

        .loading-message {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }

        .empty-message {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #666;
        }

        .user-best-score {
            margin-top: 20px;
            text-align: center;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }

        .login-required {
            margin-top: 20px;
            text-align: center;
            padding: 15px;
            background-color: #fff3cd;
            border-radius: 4px;
        }

        .login-link {
            display: inline-block;
            margin-top: 10px;
            background-color: #007bff;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
        }

        .login-link:hover {
            background-color: #0069d9;
        }
    </style>
</head>

<body>
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div id="header"></div>

    <!-- é¡µé¢ä¸»ä½“ -->
    <main class="main-content">
        <div class="container">
            <div class="leaderboard-container">
                <h1 style="text-align: center; margin-bottom: 30px;">æ¸¸æˆæ’è¡Œæ¦œ</h1>

                <div class="game-selector">
                    <label for="game-select">é€‰æ‹©æ¸¸æˆï¼š</label>
                    <select id="game-select">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                </div>

                <div id="leaderboard-content">
                    <div id="loading-message" class="loading-message">åŠ è½½æ’è¡Œæ¦œæ•°æ®ä¸­...</div>

                    <table id="leaderboard-table" class="leaderboard-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>ç”¨æˆ·å</th>
                                <th>åˆ†æ•°</th>
                                <th>æ—¥æœŸ</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <!-- æ’è¡Œæ¦œæ•°æ®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>

                    <div id="empty-message" class="empty-message" style="display: none;">
                        æš‚æ— æ’è¡Œæ¦œæ•°æ®
                    </div>
                </div>

                <div id="user-best-score" class="user-best-score" style="display: none;">
                    <h3>æ‚¨çš„æœ€é«˜åˆ†: <span id="user-best-score-value">0</span></h3>
                </div>

                <div id="login-required" class="login-required" style="display: none;">
                    <p>ç™»å½•åå¯ä»¥æŸ¥çœ‹æ‚¨çš„æœ€é«˜åˆ†ï¼Œå¹¶å‚ä¸æ’è¡Œæ¦œç«äº‰ï¼</p>
                    <a href="/user/login.html" class="login-link">ç«‹å³ç™»å½•</a>
                </div>
            </div>
        </div>
    </main>

    <!-- é¡µé¢åº•éƒ¨ -->
    <div id="footer"></div>

    <!-- å¼•å…¥jQuery -->
    <script src="../assets/js/jquery-3.6.0.min.js"></script>
    <script>
        // åŠ è½½headerå’Œfooter
        $("#header").load("/components/header.html");
        $("#footer").load("/components/footer.html");

        // å½“å‰é€‰æ‹©çš„æ¸¸æˆ
        let currentGame = '';

        // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½æ’è¡Œæ¦œ
        document.addEventListener('DOMContentLoaded', function () {
            // é¦–å…ˆåŠ è½½æ¸¸æˆåˆ—è¡¨
            loadGamesList();

            // ç»‘å®šæ¸¸æˆé€‰æ‹©å™¨å˜åŒ–äº‹ä»¶
            document.getElementById('game-select').addEventListener('change', function () {
                currentGame = this.value;
                if (currentGame) {
                    loadLeaderboard(currentGame);
                }
            });

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            checkLoginStatus();
        });

        // åŠ è½½æ¸¸æˆåˆ—è¡¨
        function loadGamesList() {
            fetch('/api/get_games.php')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.games && data.games.length > 0) {
                        const selectElement = document.getElementById('game-select');
                        selectElement.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹

                        // æ·»åŠ æ¸¸æˆé€‰é¡¹
                        data.games.forEach(game => {
                            const option = document.createElement('option');
                            option.value = game.slug;
                            option.textContent = game.name;
                            selectElement.appendChild(option);
                        });

                        // è®¾ç½®å½“å‰æ¸¸æˆå¹¶åŠ è½½æ’è¡Œæ¦œ
                        currentGame = selectElement.value;
                        loadLeaderboard(currentGame);
                    } else {
                        // æ¸¸æˆåˆ—è¡¨ä¸ºç©º
                        const selectElement = document.getElementById('game-select');
                        selectElement.innerHTML = '<option value="">æš‚æ— æ¸¸æˆ</option>';

                        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
                        document.getElementById('loading-message').style.display = 'none';
                        document.getElementById('empty-message').textContent = 'æš‚æ— æ¸¸æˆæ•°æ®ï¼Œè¯·å…ˆæ·»åŠ æ¸¸æˆ';
                        document.getElementById('empty-message').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('è·å–æ¸¸æˆåˆ—è¡¨å‡ºé”™:', error);
                    const selectElement = document.getElementById('game-select');
                    selectElement.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';

                    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                    document.getElementById('loading-message').style.display = 'none';
                    document.getElementById('empty-message').textContent = 'åŠ è½½æ¸¸æˆåˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                    document.getElementById('empty-message').style.display = 'block';
                });
        }

        // åŠ è½½æ’è¡Œæ¦œæ•°æ®
        function loadLeaderboard(gameSlug) {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading-message').style.display = 'block';
            document.getElementById('leaderboard-table').style.display = 'none';
            document.getElementById('empty-message').style.display = 'none';

            // è¯·æ±‚æ’è¡Œæ¦œæ•°æ®
            fetch(`/api/get_leaderboard.php?game_slug=${gameSlug}&limit=20`)
                .then(response => response.json())
                .then(data => {
                    // éšè—åŠ è½½çŠ¶æ€
                    document.getElementById('loading-message').style.display = 'none';

                    if (data.success) {
                        if (data.leaderboard && data.leaderboard.length > 0) {
                            // æ˜¾ç¤ºæ’è¡Œæ¦œè¡¨æ ¼
                            document.getElementById('leaderboard-table').style.display = 'table';

                            // å¡«å……æ’è¡Œæ¦œæ•°æ®
                            const tbody = document.getElementById('leaderboard-body');
                            tbody.innerHTML = '';

                            // è·å–å½“å‰ç”¨æˆ·å
                            let currentUsername = '';
                            const userData = localStorage.getItem('user_data');
                            if (userData) {
                                try {
                                    const user = JSON.parse(userData);
                                    currentUsername = user.username;
                                } catch (e) { }
                            }

                            data.leaderboard.forEach((entry, index) => {
                                const row = document.createElement('tr');

                                // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·ï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
                                if (entry.username === currentUsername) {
                                    row.classList.add('user-score');
                                }

                                // æ’åå•å…ƒæ ¼
                                const rankCell = document.createElement('td');
                                rankCell.className = 'rank-number';

                                // å‰ä¸‰åæ˜¾ç¤ºç‰¹æ®Šæ ‡è®°
                                if (index < 3) {
                                    rankCell.classList.add('top-3', `rank-${index + 1}`);

                                    // æ·»åŠ å¥–ç‰Œå›¾æ ‡
                                    let medalIcon;
                                    if (index === 0) {
                                        medalIcon = 'ğŸ¥‡';
                                    } else if (index === 1) {
                                        medalIcon = 'ğŸ¥ˆ';
                                    } else {
                                        medalIcon = 'ğŸ¥‰';
                                    }

                                    rankCell.innerHTML = `<span class="medal">${medalIcon}</span>${index + 1}`;
                                } else {
                                    rankCell.textContent = index + 1;
                                }

                                // ç”¨æˆ·åå•å…ƒæ ¼
                                const usernameCell = document.createElement('td');
                                usernameCell.textContent = entry.username;

                                // åˆ†æ•°å•å…ƒæ ¼
                                const scoreCell = document.createElement('td');
                                scoreCell.textContent = entry.score;

                                // æ—¥æœŸå•å…ƒæ ¼
                                const dateCell = document.createElement('td');
                                const date = new Date(entry.played_at);
                                dateCell.textContent = date.toLocaleDateString();

                                // æ·»åŠ æ‰€æœ‰å•å…ƒæ ¼åˆ°è¡Œ
                                row.appendChild(rankCell);
                                row.appendChild(usernameCell);
                                row.appendChild(scoreCell);
                                row.appendChild(dateCell);

                                // æ·»åŠ è¡Œåˆ°è¡¨æ ¼
                                tbody.appendChild(row);
                            });

                            // æ˜¾ç¤ºç”¨æˆ·æœ€ä½³åˆ†æ•°
                            if (data.user_best_score && data.user_best_score.best_score) {
                                document.getElementById('user-best-score').style.display = 'block';
                                document.getElementById('user-best-score-value').textContent = data.user_best_score.best_score;
                                document.getElementById('login-required').style.display = 'none';
                            } else {
                                updateUserScoreDisplay();
                            }
                        } else {
                            // æ˜¾ç¤ºç©ºæ•°æ®æ¶ˆæ¯
                            document.getElementById('empty-message').style.display = 'block';
                            updateUserScoreDisplay();
                        }
                    } else {
                        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                        document.getElementById('empty-message').textContent = 'è·å–æ’è¡Œæ¦œæ•°æ®å¤±è´¥';
                        document.getElementById('empty-message').style.display = 'block';
                        updateUserScoreDisplay();
                    }
                })
                .catch(error => {
                    console.error('è·å–æ’è¡Œæ¦œé”™è¯¯:', error);
                    document.getElementById('loading-message').style.display = 'none';
                    document.getElementById('empty-message').textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•';
                    document.getElementById('empty-message').style.display = 'block';
                    updateUserScoreDisplay();
                });
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const userData = localStorage.getItem('user_data');
            if (!userData) {
                document.getElementById('login-required').style.display = 'block';
                document.getElementById('user-best-score').style.display = 'none';
            }
        }

        // æ›´æ–°ç”¨æˆ·åˆ†æ•°æ˜¾ç¤º
        function updateUserScoreDisplay() {
            const userData = localStorage.getItem('user_data');
            if (userData) {
                document.getElementById('user-best-score').style.display = 'block';
                document.getElementById('user-best-score-value').textContent = '0';
                document.getElementById('login-required').style.display = 'none';
            } else {
                document.getElementById('user-best-score').style.display = 'none';
                document.getElementById('login-required').style.display = 'block';
            }
        }
    </script>
</body>

</html>